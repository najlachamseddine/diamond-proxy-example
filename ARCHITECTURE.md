# Diamond Proxy Architecture Diagrams

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Calls any function
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Diamond (Proxy Contract)                   â”‚
â”‚  0x123...  â—„â”€â”€â”€  Single address for all functionality   â”‚
â”‚                                                         â”‚
â”‚  fallback() {                                           â”‚
â”‚    1. Look up function selector â†’ facet address         â”‚
â”‚    2. delegatecall to facet                            â”‚
â”‚    3. Return result                                     â”‚
â”‚  }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚
         â”‚ delegatecall   â”‚ delegatecall   â”‚ delegatecall
         â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DiamondCut   â”‚  â”‚   Counter    â”‚  â”‚   ERC20      â”‚
â”‚   Facet      â”‚  â”‚   Facet      â”‚  â”‚   Facet      â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ diamondCut() â”‚  â”‚ increment()  â”‚  â”‚ transfer()   â”‚
â”‚              â”‚  â”‚ decrement()  â”‚  â”‚ mint()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Storage Layout

```
Diamond Contract Storage
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                      â”‚
â”‚  Standard Storage (slot 0, 1, 2...)                â”‚
â”‚  âŒ NOT USED - Avoided to prevent collisions        â”‚
â”‚                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Diamond Storage                                     â”‚
â”‚  ğŸ“ Position: keccak256("diamond.standard...")       â”‚
â”‚  â””â”€ Selector â†’ Facet mappings                       â”‚
â”‚  â””â”€ Facet addresses array                           â”‚
â”‚  â””â”€ Owner address                                    â”‚
â”‚                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  App Storage                                         â”‚
â”‚  ğŸ“ Position: keccak256("diamond.app.storage")      â”‚
â”‚  â””â”€ ERC20 balances                                  â”‚
â”‚  â””â”€ Counter value                                    â”‚
â”‚  â””â”€ Application state                                â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Function Call Flow

```
User calls increment() on Diamond
        â”‚
        â–¼
Diamond.fallback() triggered
        â”‚
        â”œâ”€â–º msg.sig = 0xd09de08a (increment selector)
        â”‚
        â–¼
Look up in Diamond Storage
        â”‚
        â”œâ”€â–º selectorToFacetAndPosition[0xd09de08a]
        â”‚
        â–¼
Found: CounterFacet at 0xABC...
        â”‚
        â–¼
delegatecall to CounterFacet
        â”‚
        â”œâ”€â–º Uses Diamond's storage
        â”œâ”€â–º msg.sender preserved
        â”œâ”€â–º msg.value preserved
        â”‚
        â–¼
CounterFacet.increment() executes
        â”‚
        â”œâ”€â–º Reads from LibAppStorage
        â”œâ”€â–º counter += 1
        â”œâ”€â–º Writes to LibAppStorage
        â”‚
        â–¼
Return success
        â”‚
        â–¼
User receives result
```

## DiamondCut Operation (Add Facet)

```
Step 1: Deploy New Facet
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   NewFacet.sol   â”‚
â”‚                  â”‚
â”‚  function foo()  â”‚
â”‚  function bar()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ Deploy
    0xNEW123...


Step 2: Prepare FacetCut
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FacetCut {                     â”‚
â”‚   facetAddress: 0xNEW123...    â”‚
â”‚   action: Add (0)              â”‚
â”‚   functionSelectors: [         â”‚
â”‚     0x1234... (foo selector),  â”‚
â”‚     0x5678... (bar selector)   â”‚
â”‚   ]                            â”‚
â”‚ }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 3: Execute diamondCut()
         â”‚
         â–¼
DiamondCutFacet.diamondCut()
         â”‚
         â–¼
LibDiamond.diamondCut()
         â”‚
         â”œâ”€â–º Add 0xNEW123... to facetAddresses[]
         â”œâ”€â–º Map 0x1234... â†’ 0xNEW123...
         â”œâ”€â–º Map 0x5678... â†’ 0xNEW123...
         â”‚
         â–¼
Emit DiamondCut event
         â”‚
         â–¼
âœ… Diamond now supports foo() and bar()
```

## DiamondCut Operation (Replace Facet)

```
Before:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Diamond Storage                  â”‚
â”‚                                  â”‚
â”‚ 0x1234... â†’ OldFacet (0xOLD...)  â”‚
â”‚ 0x5678... â†’ OldFacet (0xOLD...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Operation: Replace with NewFacet (0xNEW...)

After:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Diamond Storage                  â”‚
â”‚                                  â”‚
â”‚ 0x1234... â†’ NewFacet (0xNEW...)  â”‚
â”‚ 0x5678... â†’ NewFacet (0xNEW...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Note: Old implementation still exists at 0xOLD...
      but Diamond no longer routes to it
```

## Loupe Query Flow

```
User queries: "Which facets are installed?"
        â”‚
        â–¼
DiamondLoupeFacet.facets()
        â”‚
        â”œâ”€â–º Read Diamond Storage
        â”‚   â””â”€ facetAddresses[]
        â”‚   â””â”€ For each facet, get selectors
        â”‚
        â–¼
Return: [
  {
    facetAddress: 0xABC...,
    functionSelectors: [0x1234..., 0x5678...]
  },
  {
    facetAddress: 0xDEF...,
    functionSelectors: [0x9ABC..., 0xDEF0...]
  }
]
```

## Upgrade Scenario: Add Token Functionality

```
Initial State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Diamond   â”‚
â”‚             â”‚
â”‚ â”œâ”€ Counter  â”‚
â”‚ â””â”€ Loupe    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Deploy ERC20Facet:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Diamond   â”‚         â”‚ ERC20Facet   â”‚
â”‚             â”‚         â”‚              â”‚
â”‚ â”œâ”€ Counter  â”‚         â”‚ transfer()   â”‚
â”‚ â””â”€ Loupe    â”‚         â”‚ mint()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ balanceOf()  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Execute diamondCut(Add ERC20):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Diamond   â”‚
â”‚             â”‚
â”‚ â”œâ”€ Counter  â”‚
â”‚ â”œâ”€ Loupe    â”‚
â”‚ â””â”€ ERC20    â”‚ â—„â”€â”€â”€ New!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Users can now call:
- diamond.transfer(...)
- diamond.mint(...)
- diamond.balanceOf(...)
```

## Security: Storage Collision Prevention

```
âŒ WRONG - Standard Storage:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Slot 0: owner          â”‚ â—„â”€ Facet A uses slot 0
â”‚ Slot 1: counter        â”‚ â—„â”€ Facet B uses slot 0
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    âš ï¸ COLLISION!

âœ… CORRECT - Diamond Storage:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Slot 0, 1, 2...  (empty)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Diamond Storage                            â”‚
â”‚ Position: keccak256("diamond.standard...")  â”‚
â”‚ All facets read/write here                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ App Storage                                â”‚
â”‚ Position: keccak256("diamond.app...")      â”‚
â”‚ Application state shared across facets     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   âœ… No collisions possible
```

## Comparison: Traditional Proxy vs Diamond

```
Traditional Proxy Pattern:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Proxy  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ delegatecall
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Logic   â”‚
â”‚ (ALL)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Limited by 24KB!

Diamond Proxy Pattern:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Diamond â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Logic A â”‚â”‚Logic B â”‚â”‚Logic C â”‚â”‚Logic D â”‚
â”‚        â”‚â”‚        â”‚â”‚        â”‚â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Each facet < 24KB, unlimited total size!
```

## Real-World Example: DeFi Protocol

```
                    Diamond Proxy
                    0xDEF1...
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Lending â”‚    â”‚ Trading â”‚    â”‚ Staking â”‚
   â”‚  Facet  â”‚    â”‚  Facet  â”‚    â”‚  Facet  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                   â”‚ Shared  â”‚
                   â”‚ Storage â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

This allows:
- Each feature in separate facet
- Upgrade lending without affecting trading
- Add new features without redeployment
- All features share same liquidity/state
